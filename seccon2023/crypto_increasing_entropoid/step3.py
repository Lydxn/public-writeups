import sys
sys.path.append("dist")
from problem import *

# from step 2
from sage.misc.prandom import _pyrand
_pyrand().setstate((3, (439894772, 3351849133, 2811473712, 3417877695, 897786232, 1501520428, 483408084, 1419889009, 3440615302, 880154179, 1224660516, 3917851309, 3728292028, 1290126989, 4197030417, 1163918423, 1728075033, 340994691, 3071122053, 450105509, 2688733957, 2566781558, 2030959978, 3465165461, 1741613743, 1411932015, 1401970767, 2191028081, 2436652398, 610730698, 3687986106, 4285743155, 3648914446, 519785189, 3451764023, 1123072989, 1710449310, 2160059579, 2949789272, 2066604657, 4121854212, 3975186713, 30314230, 798463833, 2350459694, 697578600, 1354968305, 2658089775, 3280953256, 2721489891, 1285128935, 2418364218, 2336205941, 651324710, 2420205878, 975940369, 1109246901, 279422156, 195578326, 3574308877, 176007582, 3385028131, 1411788727, 4260655906, 3575529263, 3031640898, 3636450531, 1569461530, 360211625, 791543498, 2163739087, 790518970, 592785167, 419333692, 2341311683, 479101478, 698372647, 3986376228, 2142461012, 1984926243, 1017748449, 1073867119, 796154203, 17385719, 3055800470, 1158658526, 2175814774, 3212800022, 760485894, 1097515170, 3190715546, 1462195308, 1021379099, 1457512870, 247321741, 2015867921, 1385972393, 633017168, 413318465, 2643386797, 1617751136, 1829463948, 1767966128, 3878451580, 3625216445, 957811227, 3256361278, 52748768, 2122388666, 2861799413, 2559569124, 2502913916, 1140537576, 3169238976, 3188673555, 693784199, 3213400564, 4068914414, 2819225169, 909863361, 519279918, 69317157, 171488248, 3689227855, 312029889, 843049091, 1784744071, 627639694, 3034747550, 2092425140, 1065736180, 3220212143, 703710643, 94648035, 1587025025, 3759650981, 706030947, 3557580971, 2157684333, 1612617706, 1191468597, 3810756661, 91643333, 4251951452, 935741006, 3977221411, 946223059, 3762766340, 624325618, 3094103039, 2108187380, 128043388, 3724272288, 124666637, 1133841410, 3309327672, 1207836280, 2185828750, 3064601235, 4272444585, 3203129747, 3431386381, 3414112395, 2719220961, 2111465119, 2596220156, 1620939109, 1573848190, 349317798, 3678033203, 398328255, 1313167822, 3318338930, 4249205120, 3090304399, 2162197574, 1613339757, 3947171177, 1628345457, 1113162514, 1530688435, 2997140114, 1210858951, 2604868626, 2881639489, 3429618771, 1061892960, 2376331438, 1642068816, 3195374219, 3938949252, 2222926020, 2894418676, 2914642975, 1071618581, 2394156035, 1264963773, 2278977230, 2993326298, 2018415771, 1883947679, 763618816, 620920500, 535215024, 2283952761, 1732520410, 3146160518, 2864522628, 1482318703, 154369741, 2265694732, 434407285, 244524542, 109070418, 174229681, 2929938137, 2350918070, 3380154928, 2536795761, 3814426411, 1469702944, 3114943532, 3325263374, 1414374048, 1268212759, 3540876901, 1224536360, 4074810201, 2720601037, 89546932, 385661736, 1854278501, 4275269660, 1590897566, 442878939, 1807562851, 1163925241, 1689984203, 1107802325, 3794036994, 2950693190, 64147921, 328938557, 2668512064, 2403682731, 1402253701, 1258369924, 1570935500, 3547473017, 2024242264, 4232398977, 3187104254, 3980676973, 2097228349, 711259928, 2921204429, 3504924927, 3074695640, 2807370883, 1631299712, 3614830515, 4174780822, 4173859749, 2260556851, 1462384861, 2707504731, 4116364663, 2651278748, 4055714508, 1203588336, 101513710, 2380186339, 853095158, 730061494, 696185443, 4127183550, 2586057565, 1984428479, 2100418947, 3553919918, 1669000320, 4242619067, 2938436555, 4135229145, 1419912318, 1299829883, 1224580096, 3469709701, 4025720401, 3078784562, 3313308902, 1712397529, 3197491216, 1257458627, 1896005798, 1470018399, 1928009268, 2627476959, 3750634357, 1905034316, 1527178199, 4084785866, 655555007, 2204641417, 3720005778, 1333913182, 30919109, 1047911965, 189185180, 2637322837, 1032094744, 4243060117, 2438136931, 1173763676, 1715888142, 127077603, 3422773975, 1923982852, 1448471027, 2731835157, 933134180, 2095510736, 198567265, 2394182799, 3749689841, 1831394337, 4091937981, 2962090081, 1273216435, 3581592566, 3152322841, 43873318, 2275165250, 3442704851, 2986265167, 3695864501, 3024285352, 3644475924, 1476080443, 951544503, 3912413290, 801010689, 356456991, 1552885115, 1121188866, 742917114, 3055167064, 556409501, 616940322, 46642997, 2214095135, 449827259, 3667508774, 2889418436, 1923246658, 3079515629, 3125369669, 321098660, 91786592, 285093041, 3312730564, 1430259161, 4176904764, 2947657003, 1816971738, 851513346, 2928901835, 1919242328, 268944072, 4209803331, 338569216, 2747728654, 615198455, 2499504848, 3487275903, 2970055418, 2282085855, 432882733, 3446015972, 642234, 1840071904, 2591215403, 1454535090, 2273403665, 2048751358, 2329470509, 785126305, 4208685901, 1329484272, 606397610, 1031376050, 1163880652, 3376733849, 1166873996, 204320236, 3223096016, 790823930, 2525080828, 1911252818, 3358018570, 1649517107, 3309043932, 2466429240, 368112332, 3250467348, 2981635232, 2189078084, 1251167520, 2539081828, 3135750391, 120709760, 1142340351, 1806003730, 240204497, 3820845555, 2806292964, 2456698018, 1382813471, 4001267039, 2354528847, 3473668612, 1877883520, 3946187302, 3309310812, 1827342897, 1832132076, 3725459936, 1606461897, 1528189995, 3909517484, 840612311, 2945685885, 3248537301, 1111356697, 2415323753, 3271141623, 502657468, 1760068199, 1953365729, 2155208521, 1638796135, 510158181, 3453438973, 131139860, 3217461963, 4125560504, 3866539839, 3409665379, 2327878929, 480980948, 611523818, 783870061, 448498884, 1888415461, 658711587, 4284332017, 1679432099, 3477781829, 3730896175, 2833273075, 500240936, 2331579313, 977692559, 3837866915, 432838734, 4130497004, 3727639927, 1124668220, 3066267391, 2667611168, 3293956530, 1344400900, 1433925112, 2114797486, 4195083541, 846802784, 687825080, 2753744976, 1687639487, 3005296260, 3823229687, 2879175875, 1040927433, 3428981165, 2167389119, 865145403, 1520888563, 2163120768, 3642807568, 4105705536, 1372731981, 3425695517, 3846454291, 3942029998, 1511052234, 3778140953, 2641231567, 1108109271, 1004067438, 3060899459, 3060577340, 1372575246, 3100040095, 3364489579, 1218860831, 1584534763, 871408370, 2257471716, 3227231653, 4054966879, 3430540694, 1445763093, 569070236, 1863906199, 1874007029, 332827268, 460077847, 3011176882, 1110278146, 1762792633, 2998404117, 1267887108, 70350847, 1410728571, 3404093863, 2208182614, 403511740, 3205830014, 2831180600, 2475021544, 2669144090, 1859273570, 1643247201, 996542968, 4161802274, 1984128286, 2361739422, 1180988136, 4181243725, 4122405330, 1410402496, 2324889467, 2921702999, 2237015671, 1511162452, 1483609222, 3859661962, 2205075090, 1589952126, 3974454944, 2403962412, 2509910138, 1659003538, 2714846368, 742885777, 2479729046, 224212130, 4169586416, 2127648256, 813820559, 2623839670, 1718245502, 4224857066, 2410890025, 3229325808, 1413237932, 1342570237, 253174465, 1684074089, 3417728208, 2992073609, 1255623410, 803917156, 3964113287, 1129036902, 1724388927, 673779235, 3348148991, 2362008484, 3267063687, 4194486462, 2093610485, 2208785497, 1190623610, 2774229060, 465565749, 444634093, 256779008, 3076773253, 2099159506, 3199422823, 2221763785, 1677366535, 2443140773, 1221271457, 1434164971, 3746394030, 3506675429, 3604894182, 2341619704, 1639352218, 1010750092, 1835626112, 4019235066, 4140162871, 1697044019, 16176052, 2962107066, 1135555726, 1833464736, 2408657099, 3727346436, 1414920253, 1381812419, 1389139420, 524847765, 2907377910, 2361355725, 1172101758, 85040179, 2275956418, 555849594, 519859441, 1648304768, 0), None))

# Check DHKE works correctly by params for debug
params_debug = EntropoidParams(
    p=18446744073709550147,  # safe prime
    a3=1,
    a8=3,
    b2=3,
    b7=7,
)
E_debug = Entropoid(params_debug)
for _ in range(256):
    exec_dh(E_debug)

# Generate shared key by DHKE using strong params for production
params = EntropoidParams(
    p=0xF557D412B06B9370BA144A3FA9E4F519B4263C5232D86089B661A9D957A9DCE371F01AD4E36642F5A6377D80FC195889400EBE9C2AC91E785C841BCC3FC97ECCA78B19962692D9C049876A785F72CB66416BF5FFCF09BB8EE54D5B4501E9FD3ACC7FD87BB3A0163BECC363994C9C91E5B624AC59D032635B5CAE8B9E04FB1056F69E7493D7F00498F8CE98CA535B81FDA18BEF2DB0AE82377BDDEAFBAA1D8FDA157C923D66D1330B149213A2BF56E25755F743BDB2486D976EDF01C91D963481C31B6634A2B9F7FDC9FA63DF5DEC5F55D3BBF28E43863F26A55FD6AD668C9087228464C1D5EE4F83E82869C401568B8C1E6420423CF110091548CBAB57DBE4F7,  # safe prime
    a3=1,
    a8=3,
    b2=3,
    b7=7,
)
E = Entropoid(params)
s_ab = exec_dh(E)
key = sha256(s_ab.to_bytes()).digest()
cipher = AES.new(key, AES.MODE_ECB)
enc = bytes.fromhex("7acf40c1d41b0cfa02e462c92706cf7272326d327837cc0879a109afdab4cf5bb2691fdb37075bd46c280e94a81a1da0a13730bc85e8c18262dda8d40a6683012a986f4bad5d0e744128ac89e4daf2ca6185add951aa79749611b3df7ecb4f28827954e4323de7d3d93a4219d118d6e72a5ecb66290351d49637d7f3ed585c7246e2be84622aa6ae7dc87816f143663e664721313295c705ed5c16ce36a9760cd54f655340b6b4f98c0e21328f8bb7bb0c0b346e88db8146d8c9bfcc1ad34a26")
flag = cipher.decrypt(enc)
print(flag)

# SECCON{The law of entropoid increase postulates the existence of irreversible processes in crypto: the bit numbers of a safe cryptosystem based on DELP can increase, but cannot decrease.}
